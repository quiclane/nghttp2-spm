name: nghttp2-ios-xc
on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 */4 * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: |
          set -euo pipefail
          sudo softwareupdate --install-rosetta --agree-to-license || true
          brew update
          brew install cmake ninja unzip gh || true
      - name: Gate
        id: gate
        run: |
          set -euo pipefail
          ROOT="$PWD"
          CFG="$ROOT/ci/nghttp2-upstream.txt"
          REPO="$(awk -F= '/^repo=/{print $2}' "$CFG" | tail -n1)"
          BRANCH="$(awk -F= '/^branch=/{print $2}' "$CFG" | tail -n1)"
          LAST="$ROOT/ci/last_success_epoch.txt"
          UP="$ROOT/ci/upstream_head.txt"
          now="$(date +%s)"
          last=0
          [ -f "$LAST" ] && last="$(tr -d '\r\n ' <"$LAST" || echo 0)"
          age=999999999
          [ "${last:-0}" -gt 0 ] 2>/dev/null && age="$((now-last))"
          tmp="$(mktemp -d)"
          git clone --depth 1 --branch "$BRANCH" "$REPO" "$tmp/up"
          head="$(git -C "$tmp/up" rev-parse HEAD)"
          rm -rf "$tmp"
          prev=""
          [ -f "$UP" ] && prev="$(tr -d '\r\n ' <"$UP" || true)"
          should=1
          [ "$age" -lt 345600 ] && should=0
          [ -n "${prev:-}" ] && [ "$head" = "$prev" ] && should=0
          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "now=$now" >> "$GITHUB_OUTPUT"
          echo "should=$should" >> "$GITHUB_OUTPUT"
      - name: Build
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          chmod +x ci/nghttp2-ios-script.sh
          ./ci/nghttp2-ios-script.sh
      - name: Verify output
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          test -f build-out/NGHTTP2.xcframework.zip
          test -d build-out/NGHTTP2.xcframework
          test -f build-out/NGHTTP2.xcframework/ios-arm64/libnghttp2.a
      - name: Checksum
        if: steps.gate.outputs.should == '1'
        id: sum
        run: |
          set -euo pipefail
          cs="$(swift package compute-checksum build-out/NGHTTP2.xcframework.zip)"
          echo "checksum=$cs" >> "$GITHUB_OUTPUT"
          printf "upstream=%s\nchecksum=%s\n" "${{ steps.gate.outputs.head }}" "$cs" > /tmp/release.txt
      - name: Sync repo-root artifacts
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          rm -rf NGHTTP2.xcframework NGHTTP2.xcframework.zip libnghttp2.a
          cp -R build-out/NGHTTP2.xcframework ./NGHTTP2.xcframework
          cp build-out/NGHTTP2.xcframework.zip ./NGHTTP2.xcframework.zip
          cp build-out/NGHTTP2.xcframework/ios-arm64/libnghttp2.a ./libnghttp2.a
      - name: Commit artifacts
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add NGHTTP2.xcframework NGHTTP2.xcframework.zip libnghttp2.a
          git commit -m "repo: refresh NGHTTP2 artifacts" || true
          git push origin main
      - name: Tag immutable semver
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          git fetch origin --tags
          last="$(git tag -l '1.0.*' | awk -F. 'NF==3 && $1==1 && $2==0 {print $3}' | sort -n | tail -n1)"
          [ -n "${last:-}" ] || last=1
          next="$((last+1))"
          ver="1.0.$next"
          git tag "$ver" "$(git rev-parse HEAD)"
          git push origin "$ver"
      - name: Publish release
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          short="$(echo "${{ steps.gate.outputs.head }}" | cut -c1-12)"
          tag="ios-$(date +%Y%m%d)-$short"
          gh release create "$tag" build-out/NGHTTP2.xcframework.zip --title "$tag" --notes-file /tmp/release.txt
      - name: Prune releases
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          keep=2
          repo="${GITHUB_REPOSITORY}"
          ids="$(gh api -H "Accept: application/vnd.github+json" "/repos/$repo/releases?per_page=100" --jq '.[].id')"
          n=0
          for id in $ids; do
            n="$((n+1))"
            [ "$n" -le "$keep" ] && continue
            gh api -X DELETE -H "Accept: application/vnd.github+json" "/repos/$repo/releases/$id" >/dev/null
          done
      - name: Commit state
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          mkdir -p ci
          printf "%s\n" "${{ steps.gate.outputs.head }}" > ci/upstream_head.txt
          printf "%s\n" "${{ steps.gate.outputs.now }}" > ci/last_success_epoch.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ci/upstream_head.txt ci/last_success_epoch.txt
          git commit -m "ci: update state" || true
          git push || true
